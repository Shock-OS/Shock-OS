#!/bin/bash

IFS=$'\n'

#deamon that syncs the user themes with the /usr/share/themes directory to allow root apps to use user themes

#the root check element begins

if [[ "$(id -u)" != "0" ]]
then

    echo "Script must be run as root. Exiting..."

    exit

fi

#the root check element ends

for user in /home/*
do

    user="$(basename "$user")"

    for type in {themes,icons}
    do

        linked_themes=()

        for theme in /home/"$user"/."$type"/* #creates list of themes that already have a link
        do

            theme="$(basename "$theme")"

            if [[ -L /home/"$user"/."$type"/"$theme" ]]
            then

                linked_themes+=("\"$(readlink /home/"$user"/."$type"/"$theme")\"")

                if [[ "$theme" != "$user_"* ]] #if theme not named to fit user
                then

                    mv /home/"$user"/."$type"/"$theme" /home/"$user"/."$type"/"${user}_${theme}"

                    theme="${user}_${theme}"

                fi

            elif [[ -h "$theme" ]] #remove symlink if target theme doesn't exist
            then

                rm /home/"$user"/.shock-"$type"/"$theme"

            else #if file is not a symlink, move it to the .shock-(themes/icons) directory

                mv /home/"$user"/."$type"/"$theme" /home/"$user"/.shock-"$type"

            fi

        done

        for theme in /home/"$user"/.shock-"$type" #create links to new themes.
        do

            theme="$(basename "$theme")"

            if [[ " ${linked_themes[@]} " != *"\"$theme\""* ]]
            then

                ln -s /home/"$user"/.shock-"$type"/"$theme" /home/"$user"/."$type"/"${user}_${theme}"

            fi

        done                    

        for theme in /home/"$user"/.shock-"$type"/*
        do

            theme="$(basename "$theme")"

            if [[ ! -d /usr/share/"$type"/"$theme" ]] #add new themes to their directories in /usr/share
            then

                ln -s /home/"$user"/.shock-"$type"/"$theme" /usr/share/"$type"/"$theme"

            fi

        done

        for theme in $(ls /usr/share/"$type" | grep "${user}_") #remove links to themes that no longer exist
        do

            theme="$(basename "$theme")"

            if [[ ! -d /home/"$user"/."$type"/"$theme" ]]
            then

                rm /usr/share/"$type"/"$theme"

            fi

        done

    done

done
