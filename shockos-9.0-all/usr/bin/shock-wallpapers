#!/bin/bash

#this script is the applicaton that sets wallpapers (both single image and slideshow)

if [[ -f ~/.config/shock/slideshow-background ]]
then

    source ~/.config/shock/slideshow-background

elif [[ -f ~/.config/shock/background ]]
then

    source ~/.config/shock/background

fi

if [[ "$style" == "zoom" ]]
then

    style_input='^Zoom!Tile!Centered!Scaled!Stretched!Spanned'

elif [[ "$style" == "wallpaper" ]]
then

    style_input='Zoom!^Tile!Centered!Scaled!Stretched!Spanned'

elif [[ "$style" == "centered" ]]
then

    style_input='Zoom!Tile!^Centered!Scaled!Stretched!Spanned'

elif [[ "$style" == "scaled" ]]
then

    style_input='Zoom!Tile!Centered!^Scaled!Stretched!Spanned'

elif [[ "$style" == "stretched" ]]
then

    style_input='Zoom!Tile!Centered!Scaled!^Stretched!Spanned'

elif [[ "$style" == "spanned" ]]
then

    style_input='Zoom!Tile!Centered!Scaled!Stretched!^Spanned'

else

    style_input='Zoom!Tile!Centered!Scaled!Stretched!Spanned'

fi

if [[ "$style" == "zoom" ]]
then

    style_input_siw='^Zoom!Tile!Centered!Scaled!Stretched!Spanned'

elif [[ "$style" == "wallpaper" ]]
then

    style_input_siw='Zoom!^Tile!Centered!Scaled!Stretched!Spanned'

elif [[ "$style" == "centered" ]]
then

    style_input_siw='Zoom!Tile!^Centered!Scaled!Stretched!Spanned'

elif [[ "$style" == "scaled" ]]
then

    style_input_siw='Zoom!Tile!Centered!^Scaled!Stretched!Spanned'

elif [[ "$style" == "stretched" ]]
then

    style_input_siw='Zoom!Tile!Centered!Scaled!^Stretched!Spanned'

elif [[ "$style" == "spanned" ]]
then

    style_input_siw='Zoom!Tile!Centered!Scaled!Stretched!^Spanned'

else

    style_input_siw='Zoom!Tile!Centered!Scaled!Stretched!Spanned'

fi

yad --width=320 --text-align=center --buttons-layout=center --title="Desktop Background" --window-icon="background" --text="Please choose a background style:" --button="Single Image"\!image-x-generic --button="Slideshow"\!folder-images

wt=$?

if [[ "$wt" == "0" ]] #single image
then

    wallpaper_is_image="no"

    until [[ "$wallpaper_is_image" == "yes" ]]
    do
    
        choose=$(yad --width=300 --title="Single Image Background" --window-icon="background" --form --field="Image:":FL "$siw" --field="Style:":CB "$style_input_siw" --field="Change Background Colors":BTN 'shock-background-color-chooser' --button="Reset to Default"\!gtk-revert:1 --button="Apply"\!gtk-ok:0 --button="Cancel"\!gtk-cancel:2)

        ex=$?

        if [[ "$ex" == "1" ]]
        then

            systemctl --user stop shock-slideshow-background-daemon.service

            rm ~/.config/shock/slideshow-background

            rm ~/.config/shock/background

            dconf reset /org/mate/desktop/background/picture-options

            dconf reset /org/mate/desktop/background/picture-filename

            dconf reset /org/mate/desktop/background/color-shading-type

            dconf reset /org/mate/desktop/background/primary-color

            dconf reset /org/mate/desktop/background/secondary-color

            exit

        elif [[ "$ex" == "0" ]]
        then

            siw=$(echo "$choose" | cut -d '|' -f1)

            wallpaper_is_image="$(file "$siw")"

            if [[ "$wallpaper_is_image" == *"image"* ]]
            then

                wallpaper_is_image="yes"

                style=$(echo "$choose" | awk -F'|' '{print $2}')

                style=$(echo "$style" | awk '{print tolower($0)}') #this command makes all the letters lowercase

                if [[ "$style" == "tile" ]]
                then

                    style="wallpaper"

                fi

                systemctl --user stop shock-slideshow-background-daemon.service

                rm ~/.config/shock/slideshow-background

                echo "siw='$siw'

style=\"$style\"" | tee ~/.config/shock/background

                dconf write /org/mate/desktop/background/picture-options "'$style'"

                dconf write /org/mate/desktop/background/picture-filename "'$siw'"

            else

                yad --window-icon=background --image=emblem-important --title="Not an Image" --text="The file you selected does not appear to be an image." --button="Dismiss"\!gtk-quit

            fi

        else

            exit

        fi

    done

elif [[ "$wt" == "1" ]] #slideshow
then

    dc=0

    until (( $dc > 1 )) && [[ "$dci" == *"image"* ]]
    do

        choose=$(yad --form --width=400 --height=200 --window-icon=background --title="Slideshow Background" --field="Folder containing images:":DIR "$directory" --field="Delay (minutes):":NUM "$delay"'!1..100!1' --field="Style:":CB "$style_input" --field="Play images in random order":CHK "$random_inorder" --field="Change Background Colors":BTN 'shock-background-color-chooser' --button="Apply"\!gtk-ok --button="Cancel"\!gtk-cancel)

        ex=$?

        if [[ "$ex" != "0" ]]
        then

            exit

        fi

        directory=$(echo "$choose" | cut -d '|' -f1)

        delay=$(echo "$choose" | awk -F'|' '{print $2}')

        style=$(echo "$choose" | awk -F'|' '{print $3}')

        style=$(echo "$style" | awk '{print tolower($0)}') #this command makes all the letters lowercase

        if [[ "$style" == "tile" ]]
        then

            style="wallpaper"

        fi

        random_inorder=$(echo "$choose" | awk -F'|' '{print $4}')

        dc=$(ls "$directory" | wc -l)

        cd "$directory"

        dci=$(file *)

        cd /

        if [[ "$dci" != *"image"* ]]
        then

            yad --window-icon="background" --image=emblem-important --title="No Images Found" --text="The directory you selected does not appear to contain images. The directory must contain at least two images for a slideshow background." --button="Retry"\!edit-undo

        elif (( $dc <= 1 ))
        then

            yad --window-icon="background" --image=emblem-important --title="Not Enough Images" --text="The directory you selected does not contain enough images. The directory must contain at least two images for a slideshow background." --button="Retry"\!edit-undo

        fi

    done

    rm ~/.config/shock/background

    touch ~/.config/shock/slideshow-background

    echo "directory='$directory'

delay=\"$delay\"

random_inorder=\"$random_inorder\"

style=\"$style\"" | tee ~/.config/shock/slideshow-background

    if [[ "$random_inorder" == 'TRUE' ]] #random
    then

        until [[ "$fii" == *"image"* ]]
        do

            ws="$directory/$(ls "$directory" | shuf -n 1)"

            fii=$(file "$ws")

        done

    elif [[ "$random_inorder" == 'FALSE' ]] #in order
    then

        for ws in "$directory"/*
        do

            fii=$(file "$ws")

            if [[ "$fii" == *"image"* ]]
            then

                break

            fi

        done

    fi

    dconf write /org/mate/desktop/background/picture-options "'$style'"

    dconf write /org/mate/desktop/background/picture-filename "'$ws'"

    systemctl --user restart shock-slideshow-background-daemon.service

fi
