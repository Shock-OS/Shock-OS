#!/bin/bash

#this script is designed to shuffle between wallpapers when the user has set a slideshow wallpaper

if (($(ps aux | awk '{print $1,$12}' | grep -c "$(whoami) /usr/bin/shock-slideshow-wallpaper")>3)) #exits the program if it is already running for this user
then

    exit

fi

if [[ -f ~/.config/shock-slideshow-wallpaper ]]
then

    eval $(cat ~/.config/shock-slideshow-wallpaper)

    if [[ "$random_inorder" == 'FALSE' ]] #in order
    then

        amount=$(ls "$directory" | wc -l)

        current=0

        start=$(dconf read /org/mate/desktop/background/picture-filename)

        xfile=("$directory"/*)

        until [[ "'${xfile[$current]}'" == "$start" ]]
        do

            if ((current>amount))
            then

                exit 1

            fi

            let current++
        
        done

    fi

    wait_time=$(($delay*60))

    while true
    do

        #the automatic directory refresher patch begins

        xfile=("$directory"/*) #detect added wallpapers without requiring a reboot

        amount=$(ls "$directory" | wc -l) #recounts amount of wallpapers (for in order)

        #the automatic directory refresher patch ends

        if [[ "$random_inorder" == 'TRUE' ]] #random
        then

            sleep $wait_time

            ws="$prev"

            until [[ "$ws" != "$prev" ]] && [[ "$fii" == *"image"* ]]
            do

                ws=$(ls "$directory" | shuf -n 1)

                fii=$(file "$directory/$ws")

            done

            prev="$ws"

            ws="$directory/$ws"

            dconf write /org/mate/desktop/background/picture-filename "'$ws'"

        elif [[ "$random_inorder" == 'FALSE' ]] #in order
        then

            sleep $wait_time

            ws="$prev"

            until [[ "$ws" != "$prev" ]] && [[ "$fii" == *"image"* ]]
            do

                let current++
                
                if ((current>amount))
                then

                    current=0

                fi

                ws="${xfile[$current]}"

                fii=$(file "$ws")

            done

            prev="$ws"

            dconf write /org/mate/desktop/background/picture-filename "'$ws'"

        fi

    done

fi

