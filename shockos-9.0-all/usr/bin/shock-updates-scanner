#!/bin/bash

IFS=$'\n'

#this script checks for available updates and sends a notification if any are available

if (($(ps aux | awk '{print $1,$12}' | grep -c "$(whoami) /usr/bin/shock-updates-scanner")>2)) #exits the program if it is already running for this user
then

    exit

fi

while true
do

    rm ~/.cache/shock-update-manager/notification_pid

    updates=($(apt list --upgradable | awk '{ printf "\"%s\"\n", $0 }'))

    unset "updates[0]" #removes "Listing..." from the list because it is obviously not a package

    updates+=($(flatpak remote-ls --updates --columns=app))

    if ((${#updates[@]}>0))
    then

        if [[ -f /etc/sudoers.d/shock_automatic_updates ]] #if automatic updates are enabled
        then

            if (($(ps aux | awk '{print $1,$11,$12}' | grep -c "root /bin/bash /usr/bin/shock-auto-updates")<=2)) #installs automatic updates if they aren't already running
            then

                dconf write /org/mate/desktop/lockdown/disable-log-out "true" #stops the user from accessing the shutdown menu while automatic updates are being applied.

                sudo shock-auto-updates & auto_updates_killpid=$!

            else

                auto_updates_killpid="$(ps aux | grep "root" | grep "/usr/bin/shock-auto-updates" | awk '{print $2}')"

            fi

            yad --notification --image=/usr/share/shock/auto-updates.svg --icon-size=48 --text="Automatic updates are being installed. Please do not turn off your computer." --command="" & killpid=$!

            wait "$auto_updates_killpid"

            kill "$killpid"

            dconf write /org/mate/desktop/lockdown/disable-log-out "'false'" #allows the user to access the shutdown menu.

        else

            if ((${#updates[@]}>1))
            then

                yad_text="${#updates[@]} updates are available. Click to install them."

            else

                yad_text="1 update is available. Click to install it."

            fi

            yad --notification --image=system-software-update --text="$yad_text" --command='shock-update-manager' & killpid=$!

            mkdir -p ~/.cache/shock-tmp/shock-update-manager

            echo "$killpid" | tee ~/.cache/shock-tmp/shock-update-manager/notification_pid

            wait "$killpid"

            if [[ -f ~/.cache/shock-tmp/shock-update-manager/updates_in_progress_notification_pid ]] #if updates are being installed, wait for them to finish.
            then

                wait "$(cat ~/.cache/shock-tmp/shock-update-manager/updates_in_progress_notification_pid)"

            fi

        fi

    fi

    sleep 900

done
