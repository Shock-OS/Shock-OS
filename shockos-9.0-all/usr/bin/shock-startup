#!/bin/bash

if [[ -f ~/.config/userlogstat ]]
then

    dconf write /org/mate/desktop/interface/gtk-theme "'shock-light-blue'"

    dconf write /org/mate/marco/general/theme "'shock-light-blue'"

    dconf write /org/mate/desktop/interface/icon-theme "'shock-light-blue'"

    flatpak override --user --env=GTK_THEME="shock-light-blue"

    dconf write /org/mate/desktop/peripherals/mouse/cursor-theme "'mate-black'"

    dconf write /org/onboard/theme "'/usr/share/onboard/themes/Nightshade.theme'"

    #the above command sets the onboard theme to Nightshade

    dconf write /org/mate/panel/objects/dockapplet/prefs/win-from-cur-workspace-only "'true'"

    dconf write /org/mate/panel/objects/dockapplet/prefs/pinned-apps "['chromium.desktop', 'caja-browser.desktop', 'mate-terminal.desktop', 'shockware-center.desktop']"

    #the above set of commands sets the mate-dock-applet defaults

    dconf write /org/mate/screensaver/themes "['screensavers-gnomelogo-floaters']"

    #the above command sets Lightning Bolt as the default screensaver

    dconf write /org/mate/marco/general/center-new-windows "true"
        
    #the above command sets the new window placement to the center

    dconf write /org/mate/desktop/background/show-desktop-icons "true"

    dconf write /org/mate/caja/desktop/computer-icon-visible "false"

    dconf write /org/mate/caja/desktop/home-icon-visible "true"

    dconf write /org/mate/caja/desktop/trash-icon-visible "true"

    dconf write /org/mate/caja/desktop/network-icon-visible "false"

    dconf write /org/mate/caja/desktop/volumes-visible "true"

    #the above set of commands sets the default Shock OS desktop icons

    dconf write /org/mate/desktop/session/idle-delay 15 #sets the computer to regard the session as idle after 15 minutes (screensaver starts after 15 minutes)

    #THE FLATPAK GTK THEMING PATCH BEGINS

    flatpak override --user --filesystem=$HOME/.themes

    flatpak override --user --filesystem=$HOME/.icons

    flatpak override --user --filesystem=$HOME/.shock-themes

    flatpak override --user --filesystem=$HOME/.shock-icons

    #THE FLATPAK GTK THEMING PATCH ENDS

    rm ~/.config/userlogstat

fi

if [[ "$(cat /usr/share/shock/setupvalue)" == "0" ]] #INITIAL SETUP (run as 'shock' user)
then

    dconf write /org/mate/marco/general/theme "'shock-light-blue'"

    dconf write /org/mate/desktop/peripherals/mouse/cursor-theme "'mate-black'"

    dconf write /org/mate/marco/general/center-new-windows "true"

    feh --bg-fill /usr/share/shock/initsetup-background.png

    yad --window-icon=/usr/share/shock/shock-logo.svg --title="Welcome" --picture --size=fit --filename=/usr/share/shock/initsetup-welcome-logo.png --text="
<span font_weight='bold' font_size='larger'>Welcome to Shock OS</span>\n\nLet's get your computer set up and ready to go. Click 'Next' to get started." --text-align=center --button="Next"\!go-next --width=400

    until [[ "$ex" == "0" ]]
    do

        sudo env GTK_THEME=shock-light-blue DEBIAN_FRONTEND=gnome dpkg-reconfigure tzdata locales keyboard-configuration

        ex=$?

    done

    sudo shock-users --setup #create a user

    echo "shock-startup" | tee -a ~/.bashrc

    echo "1" | tee /usr/share/shock/setupvalue
    
    yad --window-icon=gtk-refresh --image=gtk-refresh --title="Rebooting..." --text="The system will now reboot to finish the setup..." --center --fixed --no-buttons --no-escape --undecorated & sleep 5

    sudo reboot

elif [[ "$(cat /usr/share/shock/setupvalue)" == "1" ]]
then

    sudo deluser --remove-home shock #the 'shock' user has been removed

    sudo systemctl set-default graphical

    sudo rm /usr/share/shock/setupvalue

    #the default .bashrc file restoration patch begins

    sudo rm ~/.bashrc

    sudo cp /etc/skel/.bashrc ~/

    sudo chown $(whoami) ~/.bashrc

    #the default .bashrc file restoration patch ends

    sudo rm /etc/sudoers.d/initsetup-rootpriv #this command removes elevated privilages as they are no longer required.

    echo "Finalizing setup..."

    reboot

fi

dconf write /org/mate/desktop/lockdown/disable-log-out "'false'" #ensures that the user can logout and shutdown (fixes the shutdown menu being locked if the system crashed during automatic updates)

mkdir -p ~/.cache/shock-tmp

rm -r ~/.cache/shock-tmp/* &

mpg123 /usr/share/shock/startup-sound/* #this command plays the startup sound

shock-welcome &

nohup shock-slideshow-wallpaper &

nohup shock-updates-scanner &

nohup shock-release-scanner &

if [[ " $(groups "$(whoami)") " == *" shock-child "* ]] && [[ -f /usr/share/shock-pcstl/"$(whoami)"/shock-screen-time-limit ]] #if account is a child profile with a screen time limit set
then

    yad --notification --image=/usr/share/shock/parental-controls.png --text='Screen time limit is enabled for this user.' --icon-size=48 --command='' --menu='Remaining Time!shock-pcstl-timeleft!time' & killpid_pcstld=$!

    sudo shock-pcstl-daemon "$(whoami)" "$killpid_pcstld"

fi

    




