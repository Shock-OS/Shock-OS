#!/bin/bash

installed_packages=($(apt list --installed | awk -F/ '{print $1}' | uniq)) #ChatGPT

current_wm="$(gsettings get org.mate.session.required-components windowmanager)"

if [[ "$current_wm" == "'marco-no-composite'" ]]
then

    wm_selector+='Marco!Compton!Mutter (experimental)!^None'

elif [[ "$current_wm" == "'marco-compton'" ]]
then

    wm_selector='Marco!^Compton!Mutter (experimental)!None'

elif [[ "$current_wm" == "'mutter'" ]]
then

    wm_selector='Marco!Compton!^Mutter (experimental)!None'

else

    wm_selector='Marco!Compton!Mutter (experimental)!None'

fi

if [[ " ${installed_packages[@]} " != *" mutter "* ]] #if mutter is not installed, then remove it from the list of options
then

    wm_selector="${wm_selector//'!Mutter (experimental)'/}"

fi

if [[ " ${installed_packages[@]} " != *" compton "* ]] #if mutter is not installed, then remove it from the list of options
then

    wm_selector="${wm_selector//'!Compton'/}"

fi

current_buttons_layout="$(gsettings get org.mate.Marco.general button-layout)"

if [[ "$current_buttons_layout" == "':minimize,maximize,close'" ]] #Right
then

    buttons_selector='Right!Left!Right (with menu)!Left (with menu)'

elif [[ "$current_buttons_layout" == "'close,minimize,maximize:'" ]] #Left
then

    buttons_selector='Right!^Left!Right (with menu)!Left (with menu)'

elif [[ "$current_buttons_layout" == "'close,minimize,maximize:menu'" ]] #Left (with menu)
then

    buttons_selector='Right!Left!Right (with menu)!^Left (with menu)'

else #Right (with menu)

    buttons_selector='Right!Left!^Right (with menu)!Left (with menu)'

fi

output="$(yad --window-icon=preferences-system-windows --title="Windows" --form --field="Window Manager:":CB "$wm_selector" --field="Buttons Layout:":CB "$buttons_selector" --button="Reset to Default"\!edit-undo:1 --button="Apply"\!gtk-ok:0)"

ex=$?

current_wm="$(echo "$output" | awk -F'|' '{print $1}')"

current_buttons_layout="$(echo "$output" | awk -F'|' '{print $2}')"

if ((ex==1)) #reset to default
then

    gsettings set org.mate.session.required-components windowmanager "marco"

    gsettings set org.mate.Marco.general button-layout ":minimize,maximize,close"

elif ((ex==0)) #apply
then

    if [[ "$current_wm" == "Marco" ]]
    then

        gsettings set org.mate.session.required-components windowmanager "marco"

    elif [[ "$current_wm" == "Compton" ]]
    then

        gsettings set org.mate.session.required-components windowmanager "marco-compton"

    elif [[ "$current_wm" == "Mutter (experimental)" ]]
    then

        gsettings set org.mate.session.required-components windowmanager "mutter"

    else

        gsettings set org.mate.session.required-components windowmanager "marco-no-composite"

    fi

    if [[ "$current_buttons_layout" == "Right" ]]
    then

        gsettings set org.mate.Marco.general button-layout ":minimize,maximize,close"

    elif [[ "$current_buttons_layout" == "Left" ]]
    then

        gsettings set org.mate.Marco.general button-layout "close,minimize,maximize:"

    elif [[ "$current_buttons_layout" == "Right (with menu)" ]]
    then

        gsettings set org.mate.Marco.general button-layout "menu:minimize,maximize,close"

    else #Left (with menu)

        gsettings set org.mate.Marco.general button-layout "close,minimize,maximize:menu"

    fi

fi

if ((ex==0)) || ((ex==1))
then

    killall marco

    killall compton

    killall mutter

    if [[ "$current_wm" == "Mutter (experimental)" ]]
    then

        mutter --replace &

    else

        marco --replace &

    fi

fi

