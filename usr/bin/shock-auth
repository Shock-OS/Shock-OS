#!/bin/bash

SAE_PC="5555"

SAE_ATTEMPTS=1

SAE_PROGRAM_NAME="$2"

SAE_EXECUTABLE="$1"

if [[ -z "$SAE_EXECUTABLE" ]] || [[ -z "$SAE_PROGRAM_NAME" ]]
then

    echo "ERROR: Not enough information provided. Exiting...

USAGE: shock-auth [COMMAND] [NAME]"

    exit

fi

until [[ "$SAE_PC" == "0" ]]        
do

    SAE_PASSWORD=""

    SAE_ENCRYPT_PASSWORD=""

    if [[ $SAE_ATTEMPTS == 1 ]]
    then

        SAE_PASSWORD=$(yad --window-icon=changes-prevent --title="Authentication" --text="$SAE_PROGRAM_NAME requires your password to continue." --entry --hide-text --text-align=center --width=400 --button="Cancel":1 --button="Authenticate":0)
    
    else

        SAE_PASSWORD=$(yad --window-icon=changes-prevent --title="Authentication" --text="The password you entered was incorrect. Please try again." --entry --hide-text --text-align=center --width=400 --button="Cancel":1 --button="Authenticate":0)

    fi
    
    SAE_QUIT=$?

    SAE_ENCRYPT_PASSWORD=$(openssl rand -base64 12 | tr -d '/+' | head -c 16; echo)

    SAE_PASSWORD=$(echo -n $SAE_PASSWORD | openssl enc -aes-256-cbc -pass pass:$SAE_ENCRYPT_PASSWORD -pbkdf2 -base64) #encrypt the password

    if [[ "$SAE_QUIT" != "0" ]]
    then

        SAE_PASSWORD=""

        SAE_ENCRYPT_PASSWORD=""

        exit

    fi

    echo "$SAE_PASSWORD" | openssl enc -aes-256-cbc -d -pass pass:$SAE_ENCRYPT_PASSWORD -pbkdf2 -base64 | sudo -S echo "PERMISSION GRANTED"

    SAE_PC=$?

    let SAE_ATTEMPTS++

done

echo "$SAE_PASSWORD" | openssl enc -aes-256-cbc -d -pass pass:$SAE_ENCRYPT_PASSWORD -pbkdf2 -base64 | sudo -S $SAE_EXECUTABLE $(whoami) &

SAE_PASSWORD=""

SAE_ENCRYPT_PASSWORD=""

    
