#!/bin/bash

if [[ -f ~/.shock_kidprofile ]] #if kid profile
then

    exit

fi

while true
do

    sudo shock-os-update-manager-refresh

    if [[ "$(apt list --upgradable)" == *"upgradable"* ]]
    then

        if [[ -f /etc/sudoers.d/shock_automatic_updates ]]
        then

            shock-auto-updates-kickstart

            sudo shock-os-update-manager-refresh

            if [[ "$(apt list --upgradable)" != *"upgradable"* ]]
            then

                current_version="$(echo "$(apt-show-versions shock-os-metapackage)" | cut -d" " -f2-2)"

                current_version_nodecimal="$(echo "$(apt-show-versions shock-os-metapackage)" | cut -d" " -f2-2)"

                if [[ "$current_version" == *"."* ]]
                then

                    current_version_nodecimal=$(sed 's/[.].*//' <<< "$current_version")

                fi

                rm /shock/codenames

                wget https://raw.githubusercontent.com/Shock-OS/Upgrade-Packages/main/codenames -P /shock

                latest_version="$(echo "$(wc -l /shock/codenames)" | cut -f1 -d" ")"

                if ((latest_version>current_version_nodecimal))
                then

                    yad --notification --image=/shock/shock-release-upgrader.svg --icon-size=48 --title="Shock OS Release Upgrader" --text="The upgrade to Shock OS $upgrto_version $upgrto_codename is available."

                    shock-authenticator shock-release-upgrader "Shock Release Upgrader"

                fi

            fi

        else

            if [[ "$(apt-get -q -y --ignore-hold --allow-change-held-packages --allow-unauthenticated -s dist-upgrade | /bin/grep  ^Inst | wc -l)" == "1" ]]
            then

                yad --notification --image=system-software-update --text="1 update is available."

            else

                yad --notification --image=system-software-update --text="$(apt-get -q -y --ignore-hold --allow-change-held-packages --allow-unauthenticated -s dist-upgrade | /bin/grep  ^Inst | wc -l) updates are available."

            fi

            pi-gpk-update-viewer

            sudo shock-os-update-manager-refresh

            if [[ "$(apt list --upgradable)" != *"upgradable"* ]]
            then

                shock-release-upgrader

            fi

        fi

    else

        shock-release-upgrader

    fi

    sleep 900

done
