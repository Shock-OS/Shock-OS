#!/bin/bash

#this is the initial setup program for Bullseye-based versions of Shock OS and Raspberry Fli

#the default target should be set to 'multi-user.target'

#the 'shock' user should be set to autologin

clear

sudo dpkg-reconfigure tzdata #this will allow the user to select their country and timezone

sudo dpkg-reconfigure locales #this will allow the user to select their locale

sudo dpkg-reconfigure keyboard-configuration #this will allow the user to select their keyboard layout

sleep 1

sudo setupcon

sleep 1

cuc="n"

times=0

until [[ $cuc != "n" ]]
do

    ((times++))

    if [[ $times > 1 ]]
    then

        sudo deluser --remove-home $x

    fi

    clear

    echo "Now you must create a user. NOTE: Only letters or numbers, NO SPACES OR SYMBOLS!

Please enter the desired username below:"

    read x

    x=$(echo "$x" | awk '{print tolower($0)}') #this command makes all the letters lowercase

    x=$(echo ${x//[[:blank:]]/}) #this command removes all spaces

    x=$(echo "$x" | tr -cd '[:alnum:]._-') #this command removes all numbers

    echo $x

    sudo adduser $x #the user has been created

    clear

    echo "If the user creation did not complete successfully or you would like to make some changes, you can redo the previous step by typing 'n' followed by 'ENTER'. Otherwise, press any other key followed by 'ENTER' to continue with the setup.

Are you satisfied with the user you have created? Would you like to continue the setup? [Y/n]:"

    read cuc

    cuc=$(echo "$cuc" | awk '{print tolower($0)}') #this command makes all the letters lowercase

done

sudo usermod -a -G adm,dialout,cdrom,sudo,audio,video,plugdev,games,users,input,render,netdev,spi,i2c,gpio $x #the user has been added to the required groups

sudo cp /etc/sudoers /shock #makes a backup of the sudoers file

echo "%$x ALL=(ALL:ALL) NOPASSWD:ALL" | sudo EDITOR='tee -a' visudo #enables the user to run all commands without a password (temporarily)

sudo systemctl set-default multi-user

#the setup finalizer temporary autologin patch begins

sudo sed -i 's/#NAutoVTs=6/NAutoVTs=1/g' /etc/systemd/logind.conf

sudo echo "[Service]
ExecStart=
ExecStart=-/usr/sbin/agetty --autologin $x --noclear %I $TERM" | sudo tee -a /etc/systemd/system/getty@tty1.service.d/override.conf

sudo systemctl is-enabled getty@tty1.service

sudo systemctl enable getty@tty1.service

sudo systemctl daemon-reload

sudo echo '

file3=$(cat /shock/setupvalue)

echo $file3

if [[ $file3 == 1 ]]
then

    shock-startup

fi' >> "/home/$x/.bashrc"

#the setup finalizer temporary autologin patch ends

clear

file1=`cat setupvalue`

echo $file1

echo "1" > setupvalue

sleep 3

file1=`cat setupvalue`

echo $file1

clear

echo "The system will now perform a series of reboots.

Press 'ENTER' to continue."

read a

sudo reboot





