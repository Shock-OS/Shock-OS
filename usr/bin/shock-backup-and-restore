#!/bin/bash

yad --window-icon=package --title="Backup & Restore" --text="Welcome to Backup & Restore. Using this app, you can backup/restore your apps, games, personal files, savedata, and configuration files." --button="Backup":0 --button="Restore":1

ex=$?

if [[ "$ex" == "0" ]] #backup
then

    backup_personal_data="TRUE"

    backup_apps_list="TRUE"

    backup_archive_name="$(whoami)-backup"

    backup_archive_directory="/home/$(whoami)"

    success="no"

    until [[ "$success" == "yes" ]]
    do

        success="yes"

        output=$(yad --window-icon=package --title="Backup & Restore" --text="Which of the following would you like to backup?" --form --field="Backup personal files and settings":CHK "$backup_personal_data" --field="Backup list of installed apps and games":CHK "$backup_apps_list"  --field="":LBL '' --field="Your backup will be stored in a .shb archive. Choose the name and location for the archive below:":LBL '' --field="Backup .shb archive name":'' "$backup_archive_name" --field="Folder to place the backup .shb archive in":DIR "$backup_archive_directory" --button="Next")

        ex=$?

        if [[ "$ex" != "0" ]]
        then

            exit

        fi

        backup_personal_data=$(echo "$output" | awk -F'|' '{print $1}')

        backup_apps_list=$(echo "$output" | awk -F'|' '{print $2}')

        backup_archive_name=$(echo "$output" | awk -F'|' '{print $5}')

        backup_archive_directory=$(echo "$output" | awk -F'|' '{print $6}')

        if [[ -f "$backup_archive_directory/$backup_archive_name.shb" ]]
        then

            success="no"

            yad --window-icon=package --title="Backup & Restore" --text="A file of the name '$backup_archive_name.shb' already exists in '$backup_archive_directory'. Please delete the file, or choose a different name or folder for the backup archive." --button="Retry"

        elif [[ "$backup_apps_list" == "FALSE" ]] && [[ "$backup_personal_data" == "FALSE" ]]
        then

            yad --window-icon=package --title="Backup & Restore" --text="You have not selected anything to back up. Please check at least one of the boxes at the top to create a backup."

    done

    if [[ "$backup_apps_list" == "TRUE" ]]
    then

        echo $(comm -23 <(apt-mark showmanual | sort -u) <(gzip -dc /var/log/installer/initial-status.gz | sed -n 's/^Package: //p' | sort -u) | xargs dpkg-query -W -f='${Package} ' 2>/dev/null) | tee ~/.config/shock-backup-apps-list

    else

        rm ~/.config/shock-backup-apps-list

    fi

    if [[ "$backup_personal_data" == "TRUE" ]]
    then

        zip -rS "$backup_archive_directory/$backup_archive_name.shb" /home/$(whoami)

    else

        zip -S "$backup_archive_directory/$backup_archive_name.shb" ~/.config/shock-backup-apps-list

    fi

    yad --window-icon=package --title="Backup & Restore" --text="Congratulations! Your backup has been created in '$backup_archive_directory'!" --button="View in Files" --button="Dismiss"

    ex=$?

    if [[ "$ex" == "0" ]]
    then

        caja "$backup_archive_directory"

    fi

elif [[ "$ex" == "0" ]] #restore
then

    success="no"

    until [[ "$success" == "yes" ]]
    do

        success="yes"

        restore_archive="$(yad --window-icon=package --title="Backup & Restore" --text="Please select the .shb backup archive to restore." --file)"

        if [[ "$restore_archive" != *".shb" ]]
        then

            success="no"

            yad --window-icon=package --title="Backup & Restore" --text="Looks like the file you selected is not a .shb backup archive. Please select a .shb backup archive." --button="Retry"

        fi

    done

    yadstuff=""

    if (($(unzip -Z1 "$restore_archive" | wc -l)>1))
    then

        yadstuff="--field='Restore personal files and settings':CHK 'TRUE'"

    fi

    if [[ "$(unzip -l "$restore_archive")" == *"shock-backup-apps-list "* ]]
    then

        if [[ -z "$yadstuff" ]]
        then

            yadstuff="--field='Restore apps and games':CHK 'TRUE'"

        else

            yadstuff="$yadstuff --field='Restore apps and games':CHK 'TRUE'"

        fi

    fi

    success="no"

    until [[ "$success" == "yes" ]]
    do

        success="yes"

        restore=$(yad --window-icon=package --title="Backup & Restore" --form $yadstuff --button="Restore")

        ex=$?

        if [[ "$ex" != "0" ]]
        then

            exit

        fi

        restore_personal_data=$(echo "$restore" | awk -F'|' '{print $1}')

        restore_apps=$(echo "$restore" | awk -F'|' '{print $2}')

        if [[ "$restore_personal_data $restore_apps" != "TRUE" ]]
        then

            success="no"

            yad --window-icon=package --title="Backup & Restore" --text="You have not selected anything to restore. Please check at least one of the boxes at the top to restore this backup." --button="Retry"

        fi

    done

    if [[ "$restore_personal_data" == "TRUE" ]]
    then

        unzip "$restore_archive" -d ~/

    fi

    if [[ "$restore_apps" == "TRUE" ]]
    then

        if (($(unzip -Z1 "$restore_archive" | wc -l)>1))
        then

            sudo apt install --ignore-missing $(unzip -p "$restore_archive" .config/shock-backup-apps-list)

        else

            sudo apt install --ignore-missing $(unzip -p "$restore_archive" shock-backup-apps-list)

        fi

    fi

    #the theme restoration patch begins

    yad --window-icon=package --title="Backup & Restore" --text="Congratulations! Your backup has been restored!

NOTE: If you restored apps and games, only those that are available in the current system APT repositories have been installed. Other apps that were installed through third party PPAs or from .deb packages may need to be manually installed. If you restored personal files and settings, you may need to manually re-apply some settings. For example, to re-apply your custom themes, go to 'Themes & Colors' > 'Choose Third Party Themes/Icons/Cursors' > 'Apply'." --button="Dismiss"

fi













