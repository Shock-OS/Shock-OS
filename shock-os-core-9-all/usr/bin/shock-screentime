#!/bin/bash

IFS=$'\n'

if [[ " $(groups "$(whoami)") " == *" shock-child "* ]]
then

    child_account="TRUE"

else

    child_account="FALSE"

fi

while true
do

    key=$RANDOM

    until (($(ps aux | grep -c "$key")==1))
    do

        key=$RANDOM

    done

    usernum=1

    tabs=()

    for user in /home/*
    do

        user="$(basename "$user")"

        if [[ " $(groups "$user") " == *" shock-child "* && -f /usr/share/shock-screentime/"$user"/track-screentime ]] || [[ -f /home/"$user"/.config/shock/track-screentime ]]
        then

            screentimes=()

            if [[ -f /usr/share/shock-screentime/"$user"/dailylimit ]]
            then

                total_minutes=$(cat /usr/share/shock-screentime/"$user"/dailylimit)

            else

                total_minutes=1440

            fi

            total_minutes_display="$(shock-ss-pretty-time $total_minutes)"

            for date in $(ls -t /usr/share/shock-screentime/"$user"/dates/*)
            do

                used_minutes=$(cat "$date")

                screentimes+=("$(basename "$date")" "$(shock-ss-pretty-time $used_minutes)" "$(echo "scale=2; $used_minutes / $total_minutes * 100" | bc)")

            done

            if ((${#screentimes[@]}==0))
            then

                yad --plug=$key --tabnum=$usernum --text="There is no screen time usage data for this user yet..." &

            else

                yad --plug=$key --tabnum=$usernum --list --column="Date" --column="Time Used" --column="Percentage of $total_minutes_display used":BAR "${screentimes[@]}" &

            fi

            usernum=$((usernum+1))

            tabs+=("--tab=$user")

        fi

    done

    if [[ "$child_account" == "TRUE" ]] #if child profile
    then

        if ((${#tabs[@]}==0))
        then

            yad --window-icon=/usr/share/shock/icons/shock-screentime.svg --image=info --title="Screen Time" --text="Screen time tracking is currently disabled for all users." --button="Dismiss"\!gtk-cancel:3

        else

            yad --window-icon=/usr/share/shock/icons/shock-screentime.svg --width=600 --height=400 --title="Screen Time" --notebook --key=$key "${tabs[@]}" --button="Refresh"\!gtk-refresh

        fi

    else #if not child profile

        if ((${#tabs[@]}==0))
        then

            yad --window-icon=/usr/share/shock/icons/shock-screentime.svg --image=info --title="Screen Time" --text="Screen time tracking is currently disabled for all users. Would you like to begin tracking your screen time?

NOTE: To manage the screen time tracking settings of child profiles, use the Parental Controls app." --button="Enable screen time tracking for my account"\!gtk-ok --button="Dismiss"\!gtk-cancel

            ex=$?

            if ((ex==0)) #enable screen time tracking for this user (non-child user)
            then

               mkdir -p ~/.config/shock

               touch ~/.config/shock/track-screentime

            else

                exit

            fi

        else

            yad --window-icon=/usr/share/shock/icons/shock-screentime.svg --width=600 --height=400 --title="Screen Time" --text="Click 'Settings' to manage your screen time settings. Change screen time settings for child profiles in the Parental Controls app." --notebook --key=$key "${tabs[@]}" --buttons-layout=edge --button="Settings"\!tweaks-app:1 --button="Refresh"\!gtk-refresh:0

        fi

    fi

    ex=$?

    if ((ex==1)) #settings
    then

        if [[ -f ~/.config/shock/track-screentime ]]
        then

            track_screentime="TRUE"

        else

            track_screentime="FALSE"

        fi

        source ~/.config/shock/screentime-track-days

        if ((${#screentime_track_days}==0))
        then

            screentime_track_days=60

        fi

        output="$(yad --window-icon=/usr/share/shock/icons/shock-screentime.svg --width=200 --title="Screen Time" --form --field="Track my screen time":CHK "$track_screentime" --field="Days to track screen time":NUM "${screentime_track_days}\!1..65525" --field="Manage the screen time track days of child profiles in the Parental Controls app.":LBL '' --button="Apply"\!gtk-ok)"

        ex=$?

        if ((ex==0))
        then

            track_screentime=$(echo "$output" | awk -F'|' '{print $1}')

            screentime_track_days=$(echo "$output" | awk -F'|' '{print $2}')

            if [[ "$track_screentime" == "TRUE" ]]
            then

                mkdir -p ~/.config/shock

                touch ~/.config/shock/track-screentime

            else

                rm ~/.config/shock/track-screentime

            fi

            echo "screentime_track_days=${screentime_track_days}" | tee ~/.config/shock/screentime-track-days

        fi

    elif ((ex!=0))
    then

        exit

    fi

done
