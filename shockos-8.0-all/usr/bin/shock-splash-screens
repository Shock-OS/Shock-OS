#!/bin/bash

if [[ "$(id -u)" != "0" ]]
then

    echo "Script must be run as root. Exiting..."

    exit

fi

runuser=$1

while true
do

	splashes=()

	for i in /usr/share/plymouth/themes/*
	do

		name="$(cat "$i"/"$(basename "$i")".plymouth | grep '^Name=')"

		if [[ -n "$name" ]]
		then

			splashes+=("\"${name:5}\"")

		fi

	done

	yadlist="yad --window-icon=\"ICON HERE\" --title=\"Splash Screen\" --text=\"Please choose a splash screen.\" --list --no-headers --response=2 --width=500 --height=300 --always-print-result --column=\"Name\" ${splashes[@]} --buttons-layout=spread --button=Browse\!applications-internet --button=Install\!add --button=Remove\!remove --button=Rename\!gtk-edit --button=Use\!gtk-ok"

	setsplash="$(eval "$yadlist")"

	ex=$?

	setsplash="${setsplash%?}"

    if [[ "$ex" == "0" ]] #browse
    then

        sudo -u "$runuser" xdg-open 'https://www.gnome-look.org/browse?cat=108&ord=latest' &

	elif [[ "$ex" == "1" ]] #install
	then

		cd ~/

		file="$(yad --file --window-icon=xfce4-splash --title="Install a Splash Screen" --text="Please choose a folder or a compressed archive containing a plymouth splash screen." --button="Install"\!document-open)"

        tmpdir=$(mktemp -d)

		mkdir -p "$tmpdir"

		cd "$tmpdir"

		if [[ -f "$file" ]] #if archive
		then

			unp -f "$file"

		else #if folder

			cp -rf "$file" .

		fi

		cd "$(dirname "$(find * -name *'.plymouth')")"

		cd ..

		for i in *
		do

			if [[ -d "$i" && -f "$i"/"$i".plymouth && -f "$i"/"$i".script ]]
			then

				cp -rf "$(realpath "$i")" /usr/share/plymouth/themes

			fi

		done

		rm -rf "$tmpdir"

	elif [[ "$ex" == "2" ]] #remove
	then

		if [[ "$setsplash" == "Shock OS Spinner" ]] || [[ "$setsplash" == "Shock OS Elegant Spinner" ]] || [[ "$setsplash" == "Shock OS Dots" ]]
		then

			yad --window-icon=xfce4-splash --title="Splash Screens" --image=emblem-important --text="You cannot remove Shock OS splash screens." --button="Dismiss"

		else

			for i in /usr/share/plymouth/themes/*
			do

				name="$(cat "$i"/"$(basename "$i")".plymouth | grep '^Name=')"

				if [[ "$name" == "Name=$setsplash" ]]
				then

					rm -rf "$i"

				fi

			done

		fi

    elif [[ "$ex" == "3" ]] #rename
    then

        if [[ "$setsplash" == "Shock OS Spinner" ]] || [[ "$setsplash" == "Shock OS Elegant Spinner" ]] || [[ "$setsplash" == "Shock OS Dots" ]]
		then

			yad --window-icon=xfce4-splash --title="Rename" --image=emblem-important --text="You cannot rename Shock OS splash screens." --button="Dismiss"

		else

            success="FALSE"

            until [[ "$success" == "TRUE" ]]
            do

                newname="$(yad --window-icon=xfce4-splash --title="Rename" --text="Please enter the new name for your splash screen." --entry --entry-text="$setsplash" --button="Rename")"

                ex=$?

                if [[ "$ex" == "0" ]]
                then

                    if [[ " ${splashes[@]} " == " \"$newname\" " ]]
                    then

                        success="FALSE"

                        yad --window-icon=xfce4-splash --image=emblem-important --title="Rename" --text="A splash screen named '$newname' already exists. Please choose a different name." --button="Retry"

                    else

                        success="TRUE"

                    fi

                else

                    break

                fi

            done

            if [[ "$success" == "TRUE" ]]
            then

                for i in /usr/share/plymouth/themes/*
		        do

			        name="$(cat "$i"/"$(basename "$i")".plymouth | grep '^Name=')"

			        if [[ "$name" == "Name=$setsplash" ]]
			        then

                        sed -i "/^Name=/s/.*/Name=$newname/" "$i/$(basename "$i").plymouth"

                    fi

                done

            fi

        fi

	elif [[ "$ex" == "4" ]] #use
	then

		for i in /usr/share/plymouth/themes/*
		do

			name="$(cat "$i"/"$(basename "$i")".plymouth | grep '^Name=')"

			if [[ "$name" == "Name=$setsplash" ]]
			then

				echo "[Daemon]
Theme=$(basename "$i")
ShowDelay=0
Enable=1" | tee /etc/plymouth/plymouthd.conf

			fi

		done

	else

		exit

	fi

done
	
