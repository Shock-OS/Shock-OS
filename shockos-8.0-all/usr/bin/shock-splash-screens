#!/bin/bash

if [[ "$(id -u)" != "0" ]]
then

    echo "Script must be run as root. Exiting..."

    exit

fi

runuser=$1

while true
do

    cd /usr/share/plymouth/themes

    current_splash_dir="$(grep "^Theme=" /etc/plymouth/plymouthd.conf)"

    current_splash_dir="${current_splash_dir:6}"

    current_splash="$(grep "^Name=" "$current_splash_dir/$current_splash_dir.plymouth")"

    current_splash="${current_splash:5}"

	splashes=()

	for i in /usr/share/plymouth/themes/*
	do

		name="$(grep "^Name=" "$i"/"$(basename "$i")".plymouth)"

        name="${name:5}"

		if [[ -n "$name" ]]
		then

			splashes+=("\"$name\"")

		fi

	done

	yadlist="yad --window-icon=\"ICON HERE\" --title=\"Splash Screen\" --text=\"Please choose a splash screen. Current splash screen: $current_splash\" --list --no-headers --response=4 --width=500 --height=300 --always-print-result --column=\"Name\" ${splashes[@]} --buttons-layout=spread --button=Browse\!applications-internet --button=Install\!add --button=Remove\!remove --button=Rename\!gtk-edit --button=Use\!gtk-ok"

	setsplash="$(eval "$yadlist")"

	ex=$?

	setsplash="${setsplash%?}"

    if [[ "$ex" == "0" ]] #browse
    then

        sudo -u "$runuser" xdg-open 'https://www.gnome-look.org/browse?cat=108&ord=latest' &

	elif [[ "$ex" == "1" ]] #install
	then

		cd /home/$runuser

		file="$(yad --file --window-icon=xfce4-splash --title="Install a Splash Screen" --text="Please choose a folder or a compressed archive containing a plymouth splash screen." --button="Install"\!document-open)"

        tmpdir=$(mktemp -d)

		mkdir -p "$tmpdir"

		cd "$tmpdir"

		if [[ -f "$file" ]] #if archive
		then

			unp -f "$file"

		else #if folder

			cp -rf "$file" .

		fi

		cd "$(dirname "$(find * -name *'.plymouth')")"

		cd ..

		for i in *
		do

            ito="TRUE"

            if [[ -z "$(grep "^Name=" "$i"/"$i".plymouth)" ]] && [[ -d "$i" ]]
            then

                success="FALSE"

                until [[ "$success" == "TRUE" ]]
                do

                    newname="$(yad --window-icon=xfce4-splash --title="Install a Splash Screen" --text="This splash screen in folder '$i' does not appear to have a name. Please choose a name for this splash screen." --entry --entry-text="$i" --button="Next"\!gtk-go-forward-ltr)"

                    ex=$?

                    if [[ "$ex" == "0" ]]
                    then

                        if [[ " ${splashes[@]} " == *" \"$newname\" "* ]]
                        then

                            yad --window-icon=xfce4-splash --image=emblem-important --title="Install a Splash Screen" --text="A splash screen named '$newname' already exists. Please choose a different name." --button="Retry"

                        else

                            success="TRUE"

                            echo "
[Plymouth Theme]
Name=$newname" | tee -a "$i"/"$i".plymouth

                        fi

                    else

                        break

                        ito="FALSE"

                    fi

                done

            fi

			if [[ -d "$i" ]] && [[ -f "$i"/"$i".plymouth ]] && [[ -f "$i"/"$i".script ]] && [[ "$ito" == "TRUE" ]]
			then

				cp -rf "$(realpath "$i")" /usr/share/plymouth/themes

			fi

		done

		rm -rf "$tmpdir"

	elif [[ "$ex" == "2" ]] #remove
	then

		if [[ "$setsplash" == "Shock OS Spinner" ]] || [[ "$setsplash" == "Shock OS Elegant Spinner" ]] || [[ "$setsplash" == "Shock OS Dots" ]]
		then

			yad --window-icon=xfce4-splash --title="Splash Screens" --image=emblem-important --text="You cannot remove Shock OS splash screens." --button="Dismiss"

		else

			for i in /usr/share/plymouth/themes/*
			do

				name="$(cat "$i"/"$(basename "$i")".plymouth | grep '^Name=')"

                name="${name:5}"

                if [[ "$current_splash" == "$name" ]]
                then

                    yad --window-icon=xfce4-splash --title="Splash Screens" --image=emblem-important --text="'$name' is currently in use. Please switch to a different splash screen before removing it." --button="Dismiss"

                    break

				elif [[ "$name" == "$setsplash" ]]
				then

					rm -rf "$i"

				fi

			done

		fi

    elif [[ "$ex" == "3" ]] #rename
    then

        if [[ "$setsplash" == "Shock OS Spinner" ]] || [[ "$setsplash" == "Shock OS Elegant Spinner" ]] || [[ "$setsplash" == "Shock OS Dots" ]]
		then

			yad --window-icon=xfce4-splash --title="Rename" --image=emblem-important --text="You cannot rename Shock OS splash screens." --button="Dismiss"

		else

            success="FALSE"

            until [[ "$success" == "TRUE" ]]
            do

                newname="$(yad --window-icon=xfce4-splash --title="Rename" --text="Please enter the new name for your splash screen." --entry --entry-text="$setsplash" --button="Rename"\!gtk-edit)"

                ex=$?

                if [[ "$ex" == "0" ]]
                then

                    if [[ " ${splashes[@]} " == *" \"$newname\" "* ]]
                    then

                        success="FALSE"

                        yad --window-icon=xfce4-splash --image=emblem-important --title="Rename" --text="A splash screen named '$newname' already exists. Please choose a different name." --button="Retry"

                    else

                        success="TRUE"

                    fi

                else

                    break

                fi

            done

            if [[ "$success" == "TRUE" ]]
            then

                for i in /usr/share/plymouth/themes/*
		        do

			        name="$(cat "$i"/"$(basename "$i")".plymouth | grep '^Name=')"

			        if [[ "$name" == "Name=$setsplash" ]]
			        then

                        sed -i "/^Name=/s/.*/Name=$newname/" "$i/$(basename "$i").plymouth"

                    fi

                done

            fi

        fi

	elif [[ "$ex" == "4" ]] #use
	then

		for i in /usr/share/plymouth/themes/*
		do

			name="$(cat "$i"/"$(basename "$i")".plymouth | grep '^Name=')"

			if [[ "$name" == "Name=$setsplash" ]]
			then

				echo "[Daemon]
Theme=$(basename "$i")
ShowDelay=0
Enable=1" | tee /etc/plymouth/plymouthd.conf

			fi

		done

	else

		exit

	fi

done
	
