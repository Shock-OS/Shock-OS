#!/bin/bash

#READ SETTINGS

rows_per_page=100

#READ SETTINGS ENDS

all_packages=($(find /var/lib/app-info/icons/*/* -type f -printf '%f\n' | cut -d'_' -f1 | sort | uniq)) #ChatGPT

all_packages_icons=($(find /var/lib/app-info/icons/*/* -type f | sed 's/.*/"&"/' | sort | uniq)) #ChatGPT

keyword=""

page=0

while true
do

	if [[ -n "$keyword" ]] #if keyword is not empty
	then

		search_results_prep_full=($(printf "%s\n" "${all_packages[@]}" | grep -i "$keyword"))

	else #if keyword is empty (Show All or on startup)

		search_results_prep_full=("${all_packages[@]}")

	fi

	if (("${#search_results_prep_full[@]}"==0)) #if no search results
	then

		zenity --info --window-icon=/usr/share/shockware-center/icon.svg --title="Shockware Center" --text="No results found." --ok-label="Dissmiss"

		ex=1

	else #if there are search results

		search_results_prep=("${search_results_prep_full[@]:$((rows_per_page*page))}")

		search_results_prep=("${search_results_prep[@]::$((rows_per_page))}")

		search_results=()

		for i in "${search_results_prep[@]}"
		do

			icon="$(find /var/lib/app-info/icons/*/*/"$i"_* | head -1)"

			if [[ -n "$icon" ]]
			then

				search_results+=("$icon" "$i")

			fi

		done

		if ((${#search_results_prep_full[@]}>rows_per_page))
		then

		    if ((page>0))
		    then

		        page_buttons='--button=Previous!gtk-go-forward-rtl:40 --button=Jump!gtk-jump-to-ltr:50 --button=Next!gtk-go-forward-ltr:60'

		    else

		        page_buttons='--button=Jump!gtk-jump-to-ltr:50 --button=Next!gtk-go-forward-ltr:60'

		    fi

		elif ((page>0))
		then

		    page_buttons='--button=Previous!gtk-go-forward-rtl:40 --button=Jump!gtk-jump-to-ltr:50' 

		else

		    page_buttons=""

		fi

		yadlist="yad --window-icon=/usr/share/shockware-center/icon.svg --title=\"Shockware Center\" --width=800 --height=500 --buttons-layout=spread --list --dclick-action=shockware-center-view-package --column=\"Icon\":IMG --column=\"Name\" --button=\"Search\"\!gtk-find:1 $page_buttons ${search_results[@]}"

		eval "$yadlist"

		ex=$?

	fi

	if [[ "$ex" == "40" ]] #previous
	then

		page=$((page-1))

	elif [[ "$ex" == "60" ]] #next
	then

		page=$((page+1))

	elif [[ "$ex" == "50" ]] #jump
	then

		jump_page=$(yad --window-icon=/usr/share/shockware-center/icon.svg --title="Shockware Center" --form --field="Jump to Page:":NUM "$((page+1))\!1..$(($(expr ${#search_results_prep_full[@]} / $rows_per_page)+1))" --button=Jump!gtk-jump-to-ltr)

		ex=$?

		jump_page=$(echo "$jump_page" | awk -F'|' '{print $1}')

        if [[ "$ex" == "0" ]]
        then

            page="$((jump_page-1))"

        fi

	elif [[ "$ex" == "1" ]] #search
	then

		keyword="$(yad --window-icon=/usr/share/shockware-center/icon.svg --title="Shockware Center" --text="Please enter a search term." --entry --entry-text="$keyword" --button="Search"\!gtk-find)"

		keyword=$(echo "$keyword" | awk '{print tolower($0)}') #this command makes all the letters lowercase

        keyword=$(echo ${keyword//[[:blank:]]/}) #this command removes all spaces

		page=0

	else

		exit

	fi

done


