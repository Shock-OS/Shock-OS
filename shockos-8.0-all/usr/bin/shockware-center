#!/bin/bash

IFS=$'\n'

splash_killed="FALSE"

category="All Applications"

yad --fixed --picture --filename=/usr/share/shockware-center/shockware-loader.png --size=fit --width=1000 --height=397 --undecorated --no-buttons --skip-taskbar & splash_kilpid=$!

#READ/WRITE SETTINGS BEGINS

function read_settings() {

if [[ -e ~/.config/shockware-center ]]
then

	eval "$(cat ~/.config/shockware-center)"

else

	touch ~/.config/shockware-center

	echo 'rows_per_page=100

show_apt_packages=TRUE

show_flatpaks=TRUE' | tee ~/.config/shockware-center

	rows_per_page="100"

	show_apt_packages="TRUE"

	show_flatpaks="TRUE"

fi

}

function write_settings() {

echo "rows_per_page=$rows_per_page

show_apt_packages=$show_apt_packages

show_flatpaks=$show_flatpaks" | tee ~/.config/shockware-center

}

#READ/WRITE SETTINGS ENDS

#THE LOADING FUNCTIONS BEGIN

function start_loading() {

yad --fixed --window-icon=/usr/share/shockware-center/icon.svg --title="Shockware Center" --progress-text="Loading..." --center --progress --pulsate --auto-close --undecorated --no-buttons --skip-taskbar & killpid=$!

}

function end_loading() {

kill -9 $killpid

}

#THE LOADING FUNCTIONS END

read_settings

#all_packages=($(find /var/lib/app-info/icons/*/* -type f -printf '%f\n' | cut -d'_' -f1 | sort -u | awk '{ printf "\"%s\"\n", $0 }')) #ChatGPT

all_packages_icons=($(find /var/lib/app-info/icons/*/* -type f | sed 's/.*/"&"/' | sort -u)) #ChatGPT

appstream_icons_dir="/var/lib/flatpak/appstream/flathub/$(uname -m)/active/icons/64x64"

#IFS=$'\n' read -d '' -ra all_flatpaks <<< "$(flatpak remote-ls --all --app --columns=name | awk '{print "\""$0" [FLATPAK]\""}' RS='\n')" #ChatGPT

all_flatpaks=($(grep -o '<component type="desktop[^"]*">\|<name>[^<]*</name>' "/var/lib/flatpak/appstream/flathub/$(uname -m)/active/appstream.xml" | sed -n '/<component type="desktop[^"]*">/{n; s/<name>\([^<]*\)<\/name>/"\1 [FLATPAK]"/; p}'))

IFS=$'\n' read -d '' -ra all_packages <<< "$(python /usr/bin/shockware-center-get-apt-names.py | sort -u)" #ChatGPT

IFS=$'\n' read -d '' -ra apt_packages_and_names <<< "$(python /usr/bin/shockware-center-get-apt-packages-names.py)" #ChatGPT

all_duplicates=()

for i in "${all_packages[@]}"
do

    i="${i::-7}"

    i="${i#\"}"

    echo "$i" #DEBUG

    if [[ " ${all_flatpaks[@]} " == *" \"$i [FLATPAK]\" "* ]] #if app is both an apt and a flatpak
    then

        all_duplicates+=("\"$i [BOTH]\"")

    fi

done

echo "${all_duplicates[@]}" #DEBUG

keyword=""

page=0

kill -9 $splash_kilpid

while true
do

	start_loading

	search_results_prep_full=()

    if [[ "$category" != "All Applications" ]]
    then

        if [[ "$category" == "Accessories" ]]
        then

            all_flatpaks_proxy=($(grep -B 10 '<category>Utility</category>' /var/lib/flatpak/appstream/flathub/aarch64/active/appstream.xml | grep -o '<name>[^<]*</name>' | sed 's/<name>\([^<]*\)<\/name>/"\1 [FLATPAK]"/'))

            if [[ -z "${all_apt_accessories[@]}" ]]
            then

                all_apt_accessories=($(python /usr/bin/shockware-center-search-categories-apt.py Utility))

            fi

            all_packages_proxy=("${all_apt_accessories[@]}")

        elif [[ "$category" == "Games" ]]
        then

            all_flatpaks_proxy=($(grep -B 10 '<category>Game</category>' /var/lib/flatpak/appstream/flathub/aarch64/active/appstream.xml | grep -o '<name>[^<]*</name>' | sed 's/<name>\([^<]*\)<\/name>/"\1 [FLATPAK]"/'))

            if [[ -z "${all_apt_games[@]}" ]]
            then

                all_apt_games=($(python /usr/bin/shockware-center-search-categories-apt.py Game))

            fi

            all_packages_proxy=("${all_apt_games[@]}")

        elif [[ "$category" == "Graphics" ]]
        then

            all_flatpaks_proxy=($(grep -B 10 '<category>Graphics</category>' /var/lib/flatpak/appstream/flathub/aarch64/active/appstream.xml | grep -o '<name>[^<]*</name>' | sed 's/<name>\([^<]*\)<\/name>/"\1 [FLATPAK]"/'))

            if [[ -z "${all_apt_graphics[@]}" ]]
            then

                all_apt_graphics=($(python /usr/bin/shockware-center-search-categories-apt.py Graphics))

            fi

            all_packages_proxy=("${all_apt_graphics[@]}")

        elif [[ "$category" == "Internet" ]]
        then

            all_flatpaks_proxy=($(grep -B 10 '<category>Network</category>' /var/lib/flatpak/appstream/flathub/aarch64/active/appstream.xml | grep -o '<name>[^<]*</name>' | sed 's/<name>\([^<]*\)<\/name>/"\1 [FLATPAK]"/'))

            if [[ -z "${all_apt_internet[@]}" ]]
            then

                all_apt_internet=($(python /usr/bin/shockware-center-search-categories-apt.py Network))

            fi

            all_packages_proxy=("${all_apt_internet[@]}")

        elif [[ "$category" == "Office" ]]
        then

            all_flatpaks_proxy=($(grep -B 10 '<category>Office</category>' /var/lib/flatpak/appstream/flathub/aarch64/active/appstream.xml | grep -o '<name>[^<]*</name>' | sed 's/<name>\([^<]*\)<\/name>/"\1 [FLATPAK]"/'))

            if [[ -z "${all_apt_office[@]}" ]]
            then

                all_apt_office=($(python /usr/bin/shockware-center-search-categories-apt.py Office))

            fi

            all_packages_proxy=("${all_apt_office[@]}")

        elif [[ "$category" == "Programming" ]]
        then

            all_flatpaks_proxy=($(grep -B 10 '<category>Development</category>' /var/lib/flatpak/appstream/flathub/aarch64/active/appstream.xml | grep -o '<name>[^<]*</name>' | sed 's/<name>\([^<]*\)<\/name>/"\1 [FLATPAK]"/'))

            if [[ -z "${all_apt_programming[@]}" ]]
            then

                all_apt_programming=($(python /usr/bin/shockware-center-search-categories-apt.py Development))

            fi

            all_packages_proxy=("${all_apt_programming[@]}")

        elif [[ "$category" == "Education" ]]
        then

            all_flatpaks_proxy=($(grep -B 10 '<category>Education</category>' /var/lib/flatpak/appstream/flathub/aarch64/active/appstream.xml | grep -o '<name>[^<]*</name>' | sed 's/<name>\([^<]*\)<\/name>/"\1 [FLATPAK]"/'))

            all_flatpaks_proxy+=($(grep -B 10 '<category>Science</category>' /var/lib/flatpak/appstream/flathub/aarch64/active/appstream.xml | grep -o '<name>[^<]*</name>' | sed 's/<name>\([^<]*\)<\/name>/"\1 [FLATPAK]"/'))

            if [[ -z "${all_apt_education[@]}" ]]
            then

                all_apt_education=($(python /usr/bin/shockware-center-search-categories-apt.py Education))

                all_apt_education+=($(python /usr/bin/shockware-center-search-categories-apt.py Science))

            fi

            all_packages_proxy=("${all_apt_education[@]}")

        elif [[ "$category" == "Multimedia" ]]
        then

            all_flatpaks_proxy=($(grep -B 10 '<category>AudioVideo</category>' /var/lib/flatpak/appstream/flathub/aarch64/active/appstream.xml | grep -o '<name>[^<]*</name>' | sed 's/<name>\([^<]*\)<\/name>/"\1 [FLATPAK]"/'))

            if [[ -z "${all_apt_multimedia[@]}" ]]
            then

                all_apt_multimedia=($(python /usr/bin/shockware-center-search-categories-apt.py AudioVideo))

            fi

            all_packages_proxy=("${all_apt_multimedia[@]}")

        elif [[ "$category" == "System Tools" ]]
        then

            all_flatpaks_proxy=($(grep -B 10 '<category>Settings</category>' /var/lib/flatpak/appstream/flathub/aarch64/active/appstream.xml | grep -o '<name>[^<]*</name>' | sed 's/<name>\([^<]*\)<\/name>/"\1 [FLATPAK]"/'))

            all_flatpaks_proxy+=($(grep -B 10 '<category>System</category>' /var/lib/flatpak/appstream/flathub/aarch64/active/appstream.xml | grep -o '<name>[^<]*</name>' | sed 's/<name>\([^<]*\)<\/name>/"\1 [FLATPAK]"/'))

            if [[ -z "${all_apt_system_tools[@]}" ]]
            then

                all_apt_system_tools=($(python /usr/bin/shockware-center-search-categories-apt.py Settings))

                all_apt_system_tools+=($(python /usr/bin/shockware-center-search-categories-apt.py System))

            fi

            all_packages_proxy=("${all_apt_system_tools[@]}")

        fi

    else #if no category picked

        all_packages_proxy=("${all_packages[@]}")

        all_flatpaks_proxy=("${all_flatpaks[@]}")

    fi

	if [[ -n "$keyword" ]] #if keyword is not empty
	then

		if [[ "$show_apt_packages" == "TRUE" ]]
		then

			search_results_prep_full=($(printf "%s\n" "${all_packages_proxy[@]}" | grep -i "$keyword"))

		fi

		if [[ "$show_flatpaks" == "TRUE" ]]
		then

			search_results_prep_full+=($(printf "%s\n" "${all_flatpaks_proxy[@]}" | grep -i "$keyword"))

		fi

	else #if keyword is empty (Show All or on startup)

		if [[ "$show_apt_packages" == "TRUE" ]]
		then

			search_results_prep_full=("${all_packages_proxy[@]}")

		fi

		if [[ "$show_flatpaks" == "TRUE" ]]
		then

			search_results_prep_full+=("${all_flatpaks_proxy[@]}")

		fi

	fi

	search_results_prep_full=($(printf "%s\n" "${search_results_prep_full[@]}" | sort))

	if (("${#search_results_prep_full[@]}"==0)) #if no search results
	then

		zenity --info --window-icon=/usr/share/shockware-center/icon.svg --title="Shockware Center" --text="No results found." --ok-label="Dismiss"

		if [[ "$show_apt_packages" == "FALSE" ]] && [[ "$show_flatpaks" == "FALSE" ]]
		then

			ex=1 #settings

		else

			ex=3 #search

		fi

		end_loading

	else #if there are search results

		search_results_prep=("${search_results_prep_full[@]:$((rows_per_page*page))}")

		search_results_prep=("${search_results_prep[@]::$((rows_per_page))}")

		mapfile -t search_results_prep < <(printf '%s\n' "${search_results_prep[@]}" | sed 's/^"\(.*\)"$/"\1"/' | sort -u)

		search_results=()

        if [[ "$show_apt_packages" == "TRUE" ]] && [[ "$show_flatpaks" == "TRUE" ]]
        then

            show_duplicates="TRUE"

        else

            show_duplicates="FALSE"

        fi

		for i in "${search_results_prep[@]}"
		do

			if [[ "$i" == *" [FLATPAK]\"" ]] #if Flatpak
			then

				name="${i::-11}\""

				name="${name#\"}"

				name="${name%\"}"

				icon="$(grep -A 1 -B 3 "<name>$name</name>" /var/lib/flatpak/appstream/flathub/$(uname -m)/active/appstream.xml | grep '<id>' | awk -F'[<>]' '{print $3}')"

				icon="${icon%% *}"

				icon=$(echo "$icon" | head -n1)

				if [[ "$icon" == *".desktop" ]]
				then

					icon="${icon::-8}"

				fi

				icon="$appstream_icons_dir/$icon.png"

                if [[ " ${all_duplicates[@]} " == *" ${i::-11} [BOTH]\" "* ]] && [[ "$show_duplicates" == "TRUE" ]] #if duplicate application (both APT and Flatpak) and both Flatpak and APT packages are shown.
                then

                    item_number=$(printf '%s\n' "${apt_packages_and_names[@]}" | grep -nF "${i::-11} [APT]\"" | cut -d ':' -f 1 | head -n1) #ChatGPT

                    package_name="${apt_packages_and_names[item_number]}"

                    package_name="${package_name#\"}"

				    package_name="${package_name%\"}"

			        if [[ -n "$icon" ]]
			        then

                        search_results+=("\"$icon\"" "\"$name\"" "\"B\"" "\"$icon\"" "\"$package_name\"")

			        fi

                else #if not duplicate application (Flatpak only)

				    if [[ -f "$icon" ]]
				    then

					    search_results+=("\"$icon\"" "\"$name\"" "\"F\"" "\"$icon\"" "\"N/A\"")

				    fi

                fi

			elif [[ " ${all_duplicates[@]} " != *" ${i::-7} [BOTH]\" "* ]] #if APT package
            then

                name="${i::-7}\""

                item_number=$(printf '%s\n' "${apt_packages_and_names[@]}" | grep -nF "$i" | cut -d ':' -f 1 | head -n1) #ChatGPT

                package_name="${apt_packages_and_names[item_number]}"

                package_name="${package_name#\"}"

				package_name="${package_name%\"}"

				icon="$(find /var/lib/app-info/icons/*/64x64/"$package_name"_* | head -1)" #prefer 64x64 icons

                if [[ -z "$icon" ]]
                then

                    icon="$(find /var/lib/app-info/icons/*/*/"$package_name"_* | head -1)"

                fi

				if [[ -n "$icon" ]]
				then

					search_results+=("$icon" "$name" "\"A\"" "\"$package_name\"" "\"N/A\"")

				fi

			fi

		done

		if ((${#search_results_prep_full[@]}>rows_per_page))
		then

		    if ((page>0))
		    then

		        page_buttons='--button=Previous!gtk-go-forward-rtl:40 --button=Jump!gtk-jump-to-ltr:50 --button=Next!gtk-go-forward-ltr:60'

		    else

		        page_buttons='--button=Jump!gtk-jump-to-ltr:50 --button=Next!gtk-go-forward-ltr:60'

		    fi

		elif ((page>0))
		then

		    page_buttons='--button=Previous!gtk-go-forward-rtl:40 --button=Jump!gtk-jump-to-ltr:50' 

		else

		    page_buttons=""

		fi

		yadlist="yad --fixed --window-icon=/usr/share/shockware-center/icon.svg --title=\"Shockware Center\" --text=\"Page $((page+1)) of $(($(expr ${#search_results_prep_full[@]} / $rows_per_page)+1)). Category: $category. Double-click on an app to install/remove it.\" --width=800 --height=500 --buttons-layout=spread --list --dclick-action=shockware-center-view-package --column=\"Icon\":IMG --column=\"Name\" --column=\"Type\":HD --column=\"Icon (only for Flatpaks when clicked on)\":HD --column=\"Flatpak ID column (only used for duplicate packages)\":HD --button=\"Settings\"\!gnome-settings:1 --button=\"Categories\"\!open-menu:2 --button=\"Search\"\!gtk-find:3 $page_buttons ${search_results[@]}"

		end_loading

		eval "$yadlist"

		ex=$?

	fi

	if [[ "$ex" == "40" ]] #previous
	then

		page=$((page-1))

	elif [[ "$ex" == "60" ]] #next
	then

		page=$((page+1))

	elif [[ "$ex" == "50" ]] #jump
	then

		jump_page=$(yad --fixed --window-icon=/usr/share/shockware-center/icon.svg --title="Shockware Center" --form --field="Jump to Page:":NUM "$((page+1))\!1..$(($(expr ${#search_results_prep_full[@]} / $rows_per_page)+1))" --button=Jump!gtk-jump-to-ltr)

		ex=$?

		jump_page=$(echo "$jump_page" | awk -F'|' '{print $1}')

        if [[ "$ex" == "0" ]]
        then

            page="$((jump_page-1))"

        fi

	elif [[ "$ex" == "1" ]] #settings
	then

		if [[ "$rows_per_page" == "50" ]]
		then

			rpp='^50!100!200'

		elif [[ "$rows_per_page" == "100" ]]
		then

			rpp='50!^100!200'

		else

			rpp='50!100!^200'

		fi

		settings="$(yad --fixed --window-icon=/usr/share/shockware-center/icon.svg --title="Shockware Center" --form --field="Rows per page:":CB "$rpp" --field="Show APT packages":CHK "$show_apt_packages" --field="Show Flatpaks":CHK "$show_flatpaks" --button="Apply"\!gtk-ok)"

		ex=$?

		if [[ "$ex" == "0" ]]
		then

			rows_per_page=$(echo $settings | awk 'BEGIN {FS="|" } { print $1 }')

			show_apt_packages=$(echo $settings | awk 'BEGIN {FS="|" } { print $2 }')

			show_flatpaks=$(echo $settings | awk 'BEGIN {FS="|" } { print $3 }')

			write_settings

			read_settings

		fi

    elif [[ "$ex" == "2" ]] #categories
    then

        output=$(yad --fixed --window-icon=/usr/share/shockware-center/icon.svg --title="Shockware Center" --list --no-headers --width=400 --height=300 --column="Icon":IMG --column="Category" open-menu "All Applications" applications-accessories Accessories applications-games Games applications-graphics Graphics applications-internet Internet applications-office Office applications-development Programming applications-science Education applications-multimedia Multimedia applications-system "System Tools" --button="Go")

        ex=$?

        if [[ "$ex" == "0" ]]
        then

            page=0

            keyword=""

            category=$(echo $output | awk 'BEGIN {FS="|" } { print $2 }')

        fi

	elif [[ "$ex" == "3" ]] #search
	then

		newkeyword="$(yad --fixed --window-icon=/usr/share/shockware-center/icon.svg --title="Shockware Center" --text="Please enter a search term." --entry --entry-text="$keyword" --button="Show All"\!open-menu-symbolic:1 --button="Search"\!gtk-find:0 --buttons-layout=edge)"

        ex=$?

		page=0

        if [[ "$ex" == "1" ]] #show all
        then

            keyword=""

        elif [[ "$ex" == "0" ]] #search
        then

            keyword="$newkeyword"

        fi

	else

		exit

	fi

done


