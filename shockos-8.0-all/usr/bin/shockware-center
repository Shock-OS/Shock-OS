#!/bin/bash

IFS=$'\n'

#READ/WRITE SETTINGS BEGINS

function read_settings() {

if [[ -e ~/.config/shockware-center ]]
then

	eval "$(cat ~/.config/shockware-center)"

else

	touch ~/.config/shockware-center

	echo 'rows_per_page=100

show_apt_packages=TRUE

show_flatpaks=TRUE' | tee ~/.config/shockware-center

	rows_per_page="100"

	show_apt_packages="TRUE"

	show_flatpaks="TRUE"

fi

}

function write_settings() {

echo "rows_per_page=$rows_per_page

show_apt_packages=$show_apt_packages

show_flatpaks=$show_flatpaks" | tee ~/.config/shockware-center

}

#READ/WRITE SETTINGS ENDS

#THE LOADING FUNCTIONS BEGIN

function start_loading() {

yad --window-icon=/usr/share/shockware-center/icon.svg --title="Shockware Center" --progress-text="Loading..." --center --progress --pulsate --auto-close --undecorated --no-buttons & killpid=$!

}

function end_loading() {

kill -9 $killpid

}

#THE LOADING FUNCTIONS END

read_settings

all_packages=($(find /var/lib/app-info/icons/*/* -type f -printf '%f\n' | cut -d'_' -f1 | sort | uniq | awk '{ printf "\"%s\"\n", $0 }')) #ChatGPT

all_packages_icons=($(find /var/lib/app-info/icons/*/* -type f | sed 's/.*/"&"/' | sort | uniq)) #ChatGPT

appstream_file="/var/lib/flatpak/appstream/flathub/$(uname -m)/active/appstream.xml"

appstream_icons_dir="/var/lib/flatpak/appstream/flathub/$(uname -m)/active/icons/64x64"

#mapfile -t all_flatpaks < <(grep -A1 -w -f <(printf "%s\n" "${app_ids[@]}") "${appstream_file}" | grep "<name>" | sed -e 's/<[^>]*>//g' | sed -e 's/^[[:space:]]*//' -e 's/.*/"& [FLATPAK]"/')

IFS=$'\n' read -d '' -ra all_flatpaks <<< "$(flatpak remote-ls --all --app --columns=name | awk '{print "\""$0" [FLATPAK]\""}' RS='\n')" #ChatGPT

keyword=""

page=0

while true
do

	start_loading

	search_results_prep_full=()

	if [[ -n "$keyword" ]] #if keyword is not empty
	then

		if [[ "$show_apt_packages" == "TRUE" ]]
		then

			aptkeyword=$(echo "$keyword" | awk '{print tolower($0)}') #this command makes all the letters lowercase

		    aptkeyword=$(echo ${aptkeyword//[[:blank:]]/}) #this command removes all spaces

			search_results_prep_full=($(printf "%s\n" "${all_packages[@]}" | grep -i "$aptkeyword"))

		fi

		if [[ "$show_flatpaks" == "TRUE" ]]
		then

			search_results_prep_full+=($(printf "%s\n" "${all_flatpaks[@]}" | grep -i "$keyword"))

		fi

	else #if keyword is empty (Show All or on startup)

		if [[ "$show_apt_packages" == "TRUE" ]]
		then

			search_results_prep_full=("${all_packages[@]}")

		fi

		if [[ "$show_flatpaks" == "TRUE" ]]
		then

			search_results_prep_full+=("${all_flatpaks[@]}")

		fi

	fi

	search_results_prep_full=($(printf "%s\n" "${search_results_prep_full[@]}" | sort))

	if (("${#search_results_prep_full[@]}"==0)) #if no search results
	then

		zenity --info --window-icon=/usr/share/shockware-center/icon.svg --title="Shockware Center" --text="No results found." --ok-label="Dissmiss"

		ex=1

	else #if there are search results

		search_results_prep=("${search_results_prep_full[@]:$((rows_per_page*page))}")

		search_results_prep=("${search_results_prep[@]::$((rows_per_page))}")

		mapfile -t search_results_prep < <(printf '%s\n' "${search_results_prep[@]}" | sed 's/^"\(.*\)"$/"\1"/')

		search_results=()

		duplicates=()

		for i in "${search_results_prep[@]}"
		do

			if [[ "$i" == *" [FLATPAK]\"" ]] #if Flatpak
			then

				name="${i::-11}\""

				name="${name#\"}"

				name="${name%\"}"

				icon="$(grep -A 1 -B 3 "<name>$name</name>" /var/lib/flatpak/appstream/flathub/$(uname -m)/active/appstream.xml | grep '<id>' | awk -F'[<>]' '{print $3}')"

				icon="${icon%% *}"

				icon=$(echo "$icon" | head -n1)

				if [[ "$icon" == *".desktop" ]]
				then

					icon="${icon::-8}"

				fi

				icon="$appstream_icons_dir/$icon.png"

				if [[ -f "$icon" ]]
				then

					search_results+=("\"$icon\"" "\"$name\"" "\"F\"" "\"$icon\"")

				fi

			else #if APT package

				name="${i#\"}"

				name="${name%\"}"

				icon="$(find /var/lib/app-info/icons/*/*/"$name"_* | head -1)"

				if [[ -n "$icon" ]]
				then

					search_results+=("$icon" "$i" "\"A\"" "\"A\"")

				fi

			fi

		done

		if ((${#search_results_prep_full[@]}>rows_per_page))
		then

		    if ((page>0))
		    then

		        page_buttons='--button=Previous!gtk-go-forward-rtl:40 --button=Jump!gtk-jump-to-ltr:50 --button=Next!gtk-go-forward-ltr:60'

		    else

		        page_buttons='--button=Jump!gtk-jump-to-ltr:50 --button=Next!gtk-go-forward-ltr:60'

		    fi

		elif ((page>0))
		then

		    page_buttons='--button=Previous!gtk-go-forward-rtl:40 --button=Jump!gtk-jump-to-ltr:50' 

		else

		    page_buttons=""

		fi

		yadlist="yad --window-icon=/usr/share/shockware-center/icon.svg --title=\"Shockware Center\" --text=\"Page $((page+1)) of $(($(expr ${#search_results_prep_full[@]} / $rows_per_page)+1)). Double-click on an app to install/remove it.\" --width=800 --height=500 --buttons-layout=spread --list --dclick-action=shockware-center-view-package --column=\"Icon\":IMG --column=\"Name\" --column=\"Type\":HD --column=\"Icon (only for Flatpaks when clicked on)\":HD --button=\"Settings\"\!gnome-settings:1 --button=\"Search\"\!gtk-find:2 $page_buttons ${search_results[@]}"

		end_loading

		eval "$yadlist"

		ex=$?

	fi

	if [[ "$ex" == "40" ]] #previous
	then

		page=$((page-1))

	elif [[ "$ex" == "60" ]] #next
	then

		page=$((page+1))

	elif [[ "$ex" == "50" ]] #jump
	then

		jump_page=$(yad --window-icon=/usr/share/shockware-center/icon.svg --title="Shockware Center" --form --field="Jump to Page:":NUM "$((page+1))\!1..$(($(expr ${#search_results_prep_full[@]} / $rows_per_page)+1))" --button=Jump!gtk-jump-to-ltr)

		ex=$?

		jump_page=$(echo "$jump_page" | awk -F'|' '{print $1}')

        if [[ "$ex" == "0" ]]
        then

            page="$((jump_page-1))"

        fi

	elif [[ "$ex" == "1" ]] #settings
	then

		if [[ "$rows_per_page" == "50" ]]
		then

			rpp='^50!100!200'

		elif [[ "$rows_per_page" == "100" ]]
		then

			rpp='50!^100!200'

		else

			rpp='50!100!^200'

		fi

		settings="$(yad --window-icon=/usr/share/shockware-center/icon.svg --title="Shockware Center" --form --field="Rows per page:":CB "$rpp" --field="Show APT packages":CHK "$show_apt_packages" --field="Show Flatpaks":CHK "$show_flatpaks" --button="Apply"\!gtk-ok)"

		ex=$?

		echo $settings #DEBUG

		if [[ "$ex" == "0" ]]
		then

			rows_per_page=$(echo $settings | awk 'BEGIN {FS="|" } { print $1 }')

			show_apt_packages=$(echo $settings | awk 'BEGIN {FS="|" } { print $2 }')

			show_flatpaks=$(echo $settings | awk 'BEGIN {FS="|" } { print $3 }')

			write_settings

			read_settings

		fi

	elif [[ "$ex" == "2" ]] #search
	then

		keyword="$(yad --window-icon=/usr/share/shockware-center/icon.svg --title="Shockware Center" --text="Please enter a search term." --entry --entry-text="$keyword" --button="Search"\!gtk-find)"

		page=0

	else

		exit

	fi

done


