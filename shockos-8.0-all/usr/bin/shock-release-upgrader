#!/bin/bash

#the root check element begins

if [[ "$(id -u)" != "0" ]]
then

    echo "Script must be run as root. Exiting..."

    exit

fi

#the root check element ends

current_version="$(apt-show-versions shock-os-metapackage | cut -d" " -f2-2)"

if [[ "$current_version" == "." ]]
then

	current_version="${current_version%%.*}"

fi

rm /usr/share/shock-release-upgrader/codenames

wget --timeout 5 https://raw.githubusercontent.com/Shock-OS/Shock-OS/development/upgrades/codenames -P /usr/share/shock-release-upgrader

if  [[ ! -f /usr/share/shock-release-upgrader/codenames ]]
then

	echo "An internet connection is required. Exiting..."

	exit

fi

latest_version="$(cat /usr/share/shock-release-upgrader/codenames | wc -l)"

if ((latest_version>current_version))
then

	upgrto_version=$((current_version+1))

	upgrto_version_codename="$(sed -n "$upgrto_version"p /usr/share/shock-release-upgrader/codenames)"

	if ((upgrto_version<10))
	then

		upgrto_version_display_name="$upgto_version.0"

	else

		upgrto_version_display_name="$upgrto_version"

	fi

	yad --notification --image=/shock/shock-release-upgrader.svg --icon-size=48 --text="The upgrade to Shock OS $upgrto_version_display_name $upgrto_version_codename is available. Click to upgrade."

	zenity --info --window-icon=/shock/shock-release-upgrader.svg --title="Prepare to Upgrade" --text="Before upgrading, please make sure of the following:

1. The system is connected to a constant power supply.

2. The internet connection is stable and reliable.

3. No APT packages are being installed, removed or upgraded.

NOTE: The logout and power options in the start menu will be temporarily disabled while upgrading because powering off the machine during the upgrade process is highly discouraged and may render your system unusable.

Please press 'Continue' when you are ready to go on." --width=500 --ok-label="Continue"

	mkdir -p /usr/share/shock-release-upgrader/upgrades

	wget https://github.com/Shock-OS/Shock-OS/upgrades/"$upgrto_version.zip" -P /usr/share/shock-release-upgrader/upgrades 2>&1 | sed -u 's/.* \([0-9]\+%\)\ \+\([0-9.]\+.\) \(.*\)/\1\n# Downloading at \2\/s, ETA \3/' | zenity --window-icon=/usr/share/shock-release-upgrader/icon.svg --progress --title="Downloading Upgrade Pack" --width=310 --text="Downloading the Shock OS $upgrto_version_display_name $upgrto_version_codename upgrade pack. This may take a while..." --no-cancel --auto-close

	cd /usr/share/shock-release-upgrader/upgrades

	7z e -y "$upgrto_version.zip"

	chmod --recursive 755 $upgrto_version/DEBIAN

	dpkg-deb --build -Zxz "$upgrto_version" 2>&1 | yad --center --window-icon=/shock/shock-release-upgrader.svg --title="Preparing to Upgrade..." --text="Preparing to upgrade to Shock OS $upgrto_version_display_name $upgrto_version_codename. Please sit tight, this may take a while..." -no-buttons --no-escape --undecorated --auto-close --progress --pulsate --progress-text="" --no-buttons

	sudo wget https://raw.githubusercontent.com/Shock-OS/Shock-OS/upgrades/$upgrto_version-preupgr-script -P /usr/share/shock-release-upgrader/upgrades

    if [[ -f /usr/share/shock-release-upgrader/upgrades/$upgrto_version-preupgr-script ]]
    then

        chmod +x /usr/share/shock-release-upgrader/upgrades/$upgrto_version-preupgr-script

        sudo /usr/share/shock-release-upgrader/upgrades/$upgrto_version-preupgr-script

    fi

	sudo apt install -y ./"$upgrto_version.deb" 2>&1 | yad --center --progress --pulsate --auto-close --window-icon=/shock/shock-release-upgrader.svg --title="Upgrading to Shock OS $upgrto_version_display_name $upgrto_version_codename" --text="Upgrading to Shock OS $upgrto_version_display_name $upgrto_version_codename. Please sit tight, this may take a while..." --no-buttons --no-escape --undecorated --progress-text=""

	sudo wget https://raw.githubusercontent.com/Shock-OS/Shock-OS/upgrades/$upgrto_version-postupgr-script -P /usr/share/shock-release-upgrader/upgrades

    if [[ -f /usr/share/shock-release-upgrader/upgrades/$upgrto_version-postupgr-script ]]
    then

        chmod +x /usr/share/shock-release-upgrader/upgrades/$upgrto_version-postupgr-script

        sudo /usr/share/shock-release-upgrader/upgrades/$upgrto_version-postupgr-script

    fi

	current_version="$(apt-show-versions shock-os-metapackage | cut -d" " -f2-2)"

	if ((current_version==upgrto_version))
	then

		yad --window-icon=/shock/shock-release-upgrader.svg --image=emblem-default --title="Upgrade Complete" --text="Successfully upgraded to $upgrto_version_display_name $upgrto_version_codename. Please reboot for all changes to take full effect." --button="Reboot Later" --button="Reboot Now"

		ex=$?

		if [[ "$ex" == "1" ]]
		then

			sudo reboot

		fi

	else

		yad --window-icon=/shock/shock-release-upgrader.svg --image=emblem-important --title="Upgrade Failed" --text="Failed to upgrade to $upgrto_version_display_name $upgrto_version_codename. Please try again later." --button="Dismiss"

	fi

fi

