#!/bin/bash

#this script is the applicaton that sets wallpapers (both single image and slideshow)

function set_yad_style_selection() {

if [[ "$style" == "wallpaper" ]]
then

    yad_style_selection='Zoom!^Tile!Centered!Scaled!Stretched!Spanned'

elif [[ "$style" == "centered" ]]
then

    yad_style_selection='Zoom!Tile!^Centered!Scaled!Stretched!Spanned'

elif [[ "$style" == "scaled" ]]
then

    yad_style_selection='Zoom!Tile!Centered!^Scaled!Stretched!Spanned'

elif [[ "$style" == "stretched" ]]
then

    yad_style_selection='Zoom!Tile!Centered!Scaled!^Stretched!Spanned'

elif [[ "$style" == "spanned" ]]
then

    yad_style_selection='Zoom!Tile!Centered!Scaled!Stretched!^Spanned'

else

    yad_style_selection='Zoom!Tile!Centered!Scaled!Stretched!Spanned'

fi

}

if [[ -f ~/.config/shock/slideshow-background ]]
then

    source ~/.config/shock/slideshow-background

fi

style="$(gsettings get org.mate.background picture-options | sed "s/'//g")"

yad --width=320 --text-align=center --buttons-layout=center --title="Desktop Background" --window-icon=preferences-desktop-wallpaper --text="Please choose a background style:" --button="Single Image"\!image-x-generic --button="Slideshow"\!folder-images

ex=$?

if ((ex==0)) #single image
then

    file_is_image="no"

    until [[ "$file_is_image" == "yes" ]]
    do

        set_yad_style_selection

        if [[ ! -f ~/.config/shock/slideshow-background ]]
        then

            background="$(gsettings get org.mate.background picture-filename | sed "s/'//g")"

            if [[ "$background" == "/usr/share/images/desktop-base/desktop-background" ]]
            then

                background="/home/$(whoami)/Pictures"

            fi

        fi
    
        output="$(yad --width=300 --title="Single Image Background" --window-icon=preferences-desktop-wallpaper --form --field="Image:":FL "$background" --field="Style:":CB "$yad_style_selection" --field="Change Background Colors"\!preferences-color:FBTN 'shock-background-color-chooser' --button="Reset to Default"\!edit-undo:1 --button="Apply"\!gtk-ok:0)"

        ex=$?

        style="$(echo "$output" | awk -F'|' '{print $2}')"

        style="$(echo "$style" | awk '{print tolower($0)}')" #this command makes all the letters lowercase

        if [[ "$style" == "tile" ]]
        then

            style="wallpaper"

        fi

        if ((ex==1))
        then

            systemctl --user stop shock-slideshow-background-daemon.service

            rm ~/.config/shock/slideshow-background

            gsettings reset org.mate.background picture-options

            gsettings reset org.mate.background picture-filename

            gsettings reset org.mate.background color-shading-type

            gsettings reset org.mate.background primary-color

            gsettings reset org.mate.background secondary-color

            exit

        elif ((ex==0))
        then

            background="$(echo "$output" | cut -d '|' -f1)"

            file_is_image="$(file "$background")"

            if [[ "$file_is_image" == *"image"* ]]
            then

                file_is_image="yes"

                systemctl --user stop shock-slideshow-background-daemon.service

                rm ~/.config/shock/slideshow-background

                gsettings set org.mate.background picture-options "$style"

                gsettings set org.mate.background picture-filename "$background"

            else

                yad --window-icon=preferences-desktop-wallpaper --image=emblem-important --title="Not an Image" --text="The file you selected does not appear to be an image." --button="Dismiss"\!gtk-cancel

            fi

        else

            exit

        fi

    done

elif ((ex==1)) #slideshow
then

    directory_count=0

    until ((directory_count>1)) && [[ "$directory_contains_images" == *"image"* ]]
    do

        if [[ -f ~/.config/shock/slideshow-background ]]
        then

            source ~/.config/shock/slideshow-background

        else

            directory="/home/$(whoami)/Pictures"

            delay=15

            random_boolean="TRUE"

        fi

        set_yad_style_selection

        output="$(yad --form --width=400 --height=200 --window-icon=preferences-desktop-wallpaper --title="Slideshow Background" --field="Folder containing images:":DIR "$directory" --field="Delay (minutes):":NUM "$delay"'!1..100!1' --field="Style:":CB "$yad_style_selection" --field="Play images in random order":CHK "$random_boolean" --field="Change Background Colors"\!preferences-color:FBTN 'shock-background-color-chooser' --button="Apply"\!gtk-ok)"

        ex=$?

        if ((ex!=0))
        then

            exit

        fi

        directory="$(echo "$output" | cut -d '|' -f1)"

        delay="$(echo "$output" | awk -F'|' '{print $2}')"

        style="$(echo "$output" | awk -F'|' '{print $3}')"

        style="$(echo "$style" | awk '{print tolower($0)}')" #this command makes all the letters lowercase

        if [[ "$style" == "tile" ]]
        then

            style="wallpaper"

        fi

        random_boolean="$(echo "$output" | awk -F'|' '{print $4}')"

        directory_count=$(ls "$directory" | wc -l)

        cd "$directory"

        directory_contains_images="$(file *)"

        cd /

        if [[ "$directory_contains_images" != *"image"* ]]
        then

            yad --window-icon=preferences-desktop-wallpaper --image=emblem-important --title="No Images Found" --text="The directory you selected does not appear to contain images. The directory must contain at least two images for a slideshow background." --button="Retry"\!edit-undo

        elif ((directory_count<=1))
        then

            yad --window-icon=preferences-desktop-wallpaper --image=emblem-important --title="Not Enough Images" --text="The directory you selected does not contain enough images. The directory must contain at least two images for a slideshow background." --button="Retry"\!edit-undo

        fi

    done

    echo "directory=\"$directory\"

delay=\"$delay\"

random_boolean=\"$random_boolean\"

style=\"$style\"" | tee ~/.config/shock/slideshow-background

    if [[ "$random_boolean" == 'TRUE' ]] #random
    then

        until [[ "$fii" == *"image"* ]]
        do

            ws="$directory/$(ls "$directory" | shuf -n 1)"

            fii=$(file "$ws")

        done

    elif [[ "$random_boolean" == 'FALSE' ]] #in order
    then

        for ws in "$directory"/*
        do

            fii=$(file "$ws")

            if [[ "$fii" == *"image"* ]]
            then

                break

            fi

        done

    fi

    gsettings set org.mate.background picture-options "$style"

    gsettings set org.mate.background picture-filename "$ws"

    systemctl --user restart shock-slideshow-background-daemon.service

fi
