#!/bin/bash

if [[ -f ~/.config/shock/userlogstat ]]
then

    gsettings set org.gnome.desktop.wm.preferences button-layout ':minimize,maximize,close'




    gsettings set org.mate.interface gtk-theme "Yaru-purple"

    gsettings set org.mate.Marco.general theme "Yaru"

    gsettings set org.mate.interface icon-theme "Yaru-purple"

    flatpak override --user --env=GTK_THEME="Yaru-purple"

    gsettings set org.mate.peripherals-mouse cursor-theme "Yaru-dark"

    gsettings set org.gnome.desktop.interface cursor-theme "Yaru-dark"

    #THE DEFAULT FONT PATCH BEGINS

    gsettings set org.mate.interface font-name "Ubuntu 11"

    gsettings set org.gnome.desktop.interface font-name "Ubuntu 11" #MUTTER COMPATIBILITY

    gsettings set org.mate.caja.desktop font "Ubuntu 11"

    gsettings set org.mate.interface document-font-name "Ubuntu 11"

    gsettings set org.gnome.desktop.interface document-font-name "Ubuntu 11" #MUTTER COMPATIBILITY

    gsettings set org.mate.interface monospace-font-name "Monospace 13"

    gsettings set org.gnome.desktop.interface monospace-font-name "Monospace 13" #MUTTER COMPATIBILITY

    gsettings set org.mate.Marco.general titlebar-font "Ubuntu Bold 11"

    gsettings set org.gnome.desktop.wm.preferences titlebar-font "Ubuntu Bold 11" #MUTTER COMPATIBILITY

    #THE DEFAULT FONT PATCH ENDS

    #THE FLATPAK GTK THEMING PATCH BEGINS

    flatpak override --user --filesystem="~/.themes:ro"

    flatpak override --user --filesystem="~/.icons:ro"

    flatpak override --user --filesystem="~/.shock/themes:ro"

    flatpak override --user --filesystem="~/.shock/icons:ro"

    flatpak override --user --filesystem="xdg-data/themes:ro"

    flatpak override --user --filesystem="~/.config/gtk-4.0:ro"

    #THE FLATPAK GTK THEMING PATCH ENDS

    rm ~/.config/shock/userlogstat

fi

if (($(cat /usr/share/shock/setupvalue)==0)) #INITIAL SETUP (run as 'shock' user)
then

    gsettings set org.mate.peripherals-mouse cursor-theme "Yaru-dark"

    gsettings set org.mate.Marco.general theme "Yaru"

    #THE DEFAULT FONT PATCH BEGINS

    gsettings set org.mate.interface font-name "Ubuntu 11"

    gsettings set org.mate.caja.desktop font "Ubuntu 11"

    gsettings set org.mate.interface document-font-name "Ubuntu 11"

    gsettings set org.mate.interface monospace-font-name "Monospace 13"

    gsettings set org.mate.Marco.general titlebar-font "Ubuntu Bold 11"

    #THE DEFAULT FONT PATCH ENDS

    feh --bg-fill /usr/share/shock/initsetup-background.png

    shock-pulseaudio-autoconfig

    while true
    do

        mpv --no-video /usr/share/shock/"Space Ambience.mp3"

    done &

    yad --window-icon=/usr/share/shock/shock-logo.svg --width=400 --title="Welcome" --picture --size=fit --filename=/usr/share/shock/initsetup-welcome-logo.png --text="
<span font_weight='bold' font_size='larger'>Welcome to Shock OS</span>\n\nLet's get your computer set up and ready to go. Click 'Next' to get started." --text-align=center --buttons-layout=center --button="Next"\!go-next

    ex=1

    until [[ "$ex" == "0" ]]
    do

        sudo env GTK_THEME=Yaru-purple DEBIAN_FRONTEND=gnome dpkg-reconfigure locales

        ex=$?

    done

    . /etc/default/locale

    ex=1

    until [[ "$ex" == "0" ]]
    do

        sudo env GTK_THEME=Yaru-purple DEBIAN_FRONTEND=gnome dpkg-reconfigure tzdata

        ex=$?

    done

    . /etc/default/locale

    ex=1

    until [[ "$ex" == "0" ]]
    do

        sudo env GTK_THEME=Yaru-purple DEBIAN_FRONTEND=gnome dpkg-reconfigure keyboard-configuration

        ex=$?

    done

    sudo udevadm trigger --subsystem-match=input --action=change

    sudo shock-users --setup #create a user

    echo "1" | tee /usr/share/shock/setupvalue
    
    yad --window-icon=gtk-refresh --image=gtk-refresh --title="Rebooting..." --text="The system will now reboot to finish the setup..." --center --fixed --no-buttons --no-escape --undecorated & sleep 5

    sudo reboot

elif (($(cat /usr/share/shock/setupvalue)==1))
then

    sudo deluser --remove-home shock #the 'shock' user has been removed

    sudo systemctl set-default graphical

    sudo rm /usr/share/shock/setupvalue

    sudo rm /usr/share/shock/"Space Ambience.mp3"

    #the default .bashrc file restoration patch begins

    sudo rm ~/.bashrc

    sudo cp /etc/skel/.bashrc ~/

    sudo chown "$(whoami)" ~/.bashrc

    #the default .bashrc file restoration patch ends

    sudo rm /etc/sudoers.d/initsetup-rootpriv #this command removes elevated privilages as they are no longer required.

    echo "Finalizing setup..."

    reboot

fi

mkdir -p ~/.cache/shock-tmp

rm -r ~/.cache/shock-tmp/* &

systemctl --user restart shock-updates-scanner.service

systemctl --user restart shock-release-scanner.service

if [[ -f ~/.shock/startup-sound ]] #this command plays the startup sound
then

    mpv --no-video ~/.shock/startup-sound

else

    mpv --no-video /usr/share/shock/startup-sound.mp3

fi

if [[ -f ~/.config/shock/welcome-indicator ]]
then

    shock-welcome &

fi

if [[ " $(groups "$(whoami)") " == *" shock-child "* ]] && [[ -f /usr/share/shock-screentime/"$(whoami)"/dailylimit ]] #if account is a child profile with a screen time limit set
then

    yad --notification --image=preferences-system-parental-controls --text='Screen time limit is enabled for this user.' --icon-size=48 --command='' --menu='Remaining Time!shock-screentime-timeleft!timer-sand-symbolic' & killpid=$!

    echo "$killpid" | tee ~/.cache/shock-tmp/screentime-limit-notification

fi

    




